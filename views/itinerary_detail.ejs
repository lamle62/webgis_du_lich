<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi tiết lịch trình</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="no-filter">
  <%- include('partials/header') %>

  <div class="container">
    <% if (itinerary) { %>
      <h1>Chi tiết lịch trình: <%- itinerary.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') %></h1>

      <% if (typeof error !== 'undefined' && error) { %>
        <p class="error"><%- error.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') %></p>
      <% } %>

      <script>
        const userData = <%= JSON.stringify(user || null) %>;
        console.log('User variable in EJS:', userData);
      </script>

      <% if (user) { %>
        <h3>Danh sách địa điểm</h3>

<% if (itinerary.places && itinerary.places.length > 0) { %>
  <table class="places-table">
    <thead>
      <tr>
        <th width="5%">STT</th>
        <th width="40%">Tên địa điểm</th>
        <th width="25%">Thời gian</th>
        <th width="15%" class="status-checkbox">Hoàn thành</th>
        <th width="15%">Hành động</th>
      </tr>
    </thead>
    <tbody>
      <% itinerary.places.forEach((place, index) => { %>
        <tr class="place-row">
          <td class="stt"><%= index + 1 %></td>
          <td>
            <strong><%- place.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') %></strong>
            <br>
            <small style="color: #666;">(<%= place.type || 'Không xác định' %>)</small>
          </td>
          <td>
            <%= place.time ? new Date(place.time).toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }) : 'Chưa đặt' %>
          </td>
          <td class="status-checkbox" data-label="Hoàn thành">
  <input type="checkbox" class="place-status-checkbox" data-place-id="<%= place.id %>" <%= place.status ? 'checked' : '' %>>
  <span class="status-label <%= place.status ? 'status-done' : 'status-pending' %>">
    <%= place.status ? 'Hoàn thành' : 'Chưa hoàn thành' %>
  </span>
</td>
          <td>
            <form action="/itineraries/<%= itinerary.id %>/remove-place" method="POST" style="display:inline;">
              <input type="hidden" name="placeId" value="<%= place.id %>">
              <button type="submit" class="btn btn-danger" style="font-size: 0.8em; padding: 6px 10px;">Xóa</button>
            </form>
          </td>
        </tr>
      <% }); %>
    </tbody>
  </table>
<% } else { %>
  <p style="color: #999; font-style: italic; text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;">
    Chưa có địa điểm nào trong lịch trình.
  </p>
<% } %>

        <div class="itinerary-actions" style="display:flex; gap:12px; align-items:center; margin:16px 0;">
          <button id="toggle-edit-form-btn" class="btn btn-ghost">Sửa lịch trình</button>
          <button id="delete-itinerary-btn" class="btn btn-danger" data-itinerary-id="<%= itinerary.id %>">Xóa lịch trình</button>
        </div>

        <!-- FORM CHỈNH SỬA - DẠNG BẢNG -->
        <div id="editForm" style="display: none;">
          <form id="edit-itinerary-form" action="/itineraries/<%= itinerary.id %>/edit" method="POST">
            <label><strong>Sửa tên lịch trình</strong></label>
            <input type="text" name="name" value="<%- itinerary.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&apos;') %>" required style="width: 100%; padding: 8px; margin-bottom: 16px;">

            <h4>Danh sách địa điểm hiện tại</h4>
            <table id="editPlaceTable">
              <thead>
                <tr>
                  <th width="5%">STT</th>
                  <th width="40%">Tên địa điểm</th>
                  <th width="25%">Thời gian</th>
                  <th width="15%" class="status-checkbox">Hoàn thành</th>
                  <th width="15%">Hành động</th>
                </tr>
              </thead>
              <tbody id="editPlaceList">
                <% if (itinerary.places && itinerary.places.length > 0) { %>
                  <% itinerary.places.forEach((place, index) => { %>
                    <tr class="edit-place-item" 
                        data-place-id="<%= place.id %>" 
                        data-place-time="<%= place.time || '' %>" 
                        data-place-status="<%= place.status === true ? 'true' : 'false' %>">
                      <td class="stt" data-label="STT"><%= index + 1 %></td>
                      <td data-label="Tên địa điểm">
                        <%- place.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&apos;') %> 
                        <small style="color:#666;">(<%- (place.type || 'Unknown') %>)</small>
                      </td>
                      <td data-label="Thời gian">
                        <input type="datetime-local" class="place-time-input" value="<%= place.time ? new Date(place.time).toISOString().slice(0, 16) : '' %>" style="width:100%;">
                      </td>
                      <td class="status-checkbox" data-label="Hoàn thành">
                        <input type="checkbox" class="place-status-checkbox" <%= place.status === true ? 'checked' : '' %>>
                      </td>
                      <td data-label="Hành động">
                        <button type="button" class="remove-place-btn" data-place-id="<%= place.id %>">Xóa</button>
                      </td>
                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr>
                    <td colspan="5" style="text-align:center; color: #999;">Chưa có địa điểm nào.</td>
                  </tr>
                <% } %>
              </tbody>
            </table>

            <h4>Thêm địa điểm mới</h4>
            <div id="add-place-section">
              <select id="addPlaceSelect" style="flex: 2; min-width: 200px; padding: 8px;">
  <option value="">Chọn địa điểm</option>
  <% allPlaces.forEach(place => { %>
    <% const isAlreadyAdded = itinerary.places?.some(p => p.id === place.id); %>
    <option value="<%= place.id %>" data-type="<%= place.type %>" <%= isAlreadyAdded ? 'disabled' : '' %>>
      <%= place.name %> (<%= place.type %> - <%= place.province %>)
      <%= isAlreadyAdded ? ' [Đã thêm]' : '' %>
    </option>
  <% }); %>
</select>
              <input type="datetime-local" id="newPlaceTime" style="flex: 1; min-width: 180px; padding: 8px;">
              <button type="button" id="add-place-btn" style="padding: 8px 12px;">Thêm</button>
            </div>

            <input type="hidden" name="places" id="editPlacesInput">
            <button type="submit" style="padding: 10px 16px; font-size: 1em;">Lưu thay đổi</button>
          </form>
        </div>
      <% } else { %>
        <p>Bạn cần đăng nhập để xem chi tiết lịch trình.</p>
      <% } %>

      <a href="/itineraries/page" style="display: inline-block; margin-top: 20px;">Quay lại danh sách lịch trình</a>
    <% } else { %>
      <p>Không tìm thấy lịch trình.</p>
      <a href="/itineraries/page">Quay lại danh sách lịch trình</a>
    <% } %>
  </div>
  <script>
    window.itineraryId = <%= itinerary.id %>;
  </script>

  <script src="/js/main.js" defer></script>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const editForm = document.getElementById('edit-itinerary-form');
  const editPlaceList = document.getElementById('editPlaceList');
  const editPlacesInput = document.getElementById('editPlacesInput');
  const addPlaceBtn = document.getElementById('add-place-btn');
  const addPlaceSelect = document.getElementById('addPlaceSelect');
  const newPlaceTime = document.getElementById('newPlaceTime');

  // Cập nhật STT
  function updateSTT() {
    const rows = editPlaceList.querySelectorAll('tr.edit-place-item');
    rows.forEach((row, index) => {
      row.querySelector('.stt').textContent = index + 1;
    });
  }

  // Cập nhật hidden input places
  function updatePlacesInput() {
    const places = [];
    const rows = editPlaceList.querySelectorAll('tr.edit-place-item');
    rows.forEach(row => {
      const placeId = parseInt(row.dataset.placeId);
      const timeInput = row.querySelector('.place-time-input');
      const statusCheckbox = row.querySelector('.place-status-checkbox');
      if (timeInput && timeInput.value) {
        places.push({
          id: placeId,
          time: new Date(timeInput.value).toISOString(),
          status: statusCheckbox.checked
        });
      }
    });
    editPlacesInput.value = JSON.stringify(places);
  }

  // Xóa địa điểm
  editPlaceList.addEventListener('click', (e) => {
    const btn = e.target.closest('.remove-place-btn');
    if (!btn) return;
    btn.closest('tr').remove();
    updateSTT();
    updatePlacesInput();
  });

  // Cập nhật khi thay đổi time/status
  editPlaceList.addEventListener('change', (e) => {
    if (e.target.matches('.place-time-input') || e.target.matches('.place-status-checkbox')) {
      updatePlacesInput();
    }
  });

  // Thêm địa điểm mới
  addPlaceBtn.addEventListener('click', () => {
    const selected = addPlaceSelect.selectedOptions[0];
    if (!selected || !selected.value) return alert('Vui lòng chọn địa điểm');
    const placeId = parseInt(selected.value);
    const placeName = selected.textContent.trim().split(' (')[0];
    const placeType = selected.dataset.type || 'Unknown';
    const time = newPlaceTime.value;
    if (!time) return alert('Vui lòng chọn thời gian');

    const newRow = document.createElement('tr');
    newRow.className = 'edit-place-item';
    newRow.dataset.placeId = placeId;
    newRow.dataset.placeTime = time;
    newRow.dataset.placeStatus = 'false';

    newRow.innerHTML = `
      <td class="stt" data-label="STT"></td>
      <td data-label="Tên địa điểm">${placeName} <small style="color:#666;">(${placeType})</small></td>
      <td data-label="Thời gian"><input type="datetime-local" class="place-time-input" value="${time}" style="width:100%;"></td>
      <td class="status-checkbox" data-label="Hoàn thành"><input type="checkbox" class="place-status-checkbox"></td>
      <td data-label="Hành động"><button type="button" class="remove-place-btn" data-place-id="${placeId}">Xóa</button></td>
    `;

    editPlaceList.appendChild(newRow);
    updateSTT();
    updatePlacesInput();

    // Reset
    addPlaceSelect.value = '';
    newPlaceTime.value = '';
  });

  // Submit form
  editForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = editForm.querySelector('input[name="name"]').value.trim();
    updatePlacesInput();
    const places = editPlacesInput.value ? JSON.parse(editPlacesInput.value) : [];

    if (!name) return alert('Vui lòng nhập tên lịch trình');
    if (places.length === 0) return alert('Vui lòng thêm ít nhất một địa điểm');
    if (places.some(p => !p.time)) return alert('Vui lòng nhập thời gian cho tất cả địa điểm');

    editForm.submit();
  });

  // Toggle form
  const toggleBtn = document.getElementById('toggle-edit-form-btn');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      const form = document.getElementById('editForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    });
  }

  // ✅ Xóa lịch trình
  const deleteBtn = document.getElementById('delete-itinerary-btn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', () => {
      const id = deleteBtn.dataset.itineraryId;
      window.deleteItinerary(id); // Gọi hàm trong main.js
    });
  }

  // Khởi tạo STT và places input
  updateSTT();
  updatePlacesInput();
});
</script>
