<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi tiết lịch trình</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="no-filter">
  <%- include('partials/header') %>

  <div class="container">
    <% if (itinerary) { %>
      <h1>Chi tiết lịch trình: <%- itinerary.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') %></h1>

      <% if (typeof error !== 'undefined' && error) { %>
        <p class="error"><%- error.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') %></p>
      <% } %>

      <script>
        // Safe serialization of server-side user object for debugging
        const userData = <%= JSON.stringify(user || null) %>;
        console.log('User variable in EJS:', userData);
      </script>

      <% if (user) { %>
        <h3>Danh sách địa điểm</h3>
        <ol>
          <% if (itinerary.places && itinerary.places.length > 0) { %>
            <% itinerary.places.forEach((place, index) => { %>
              <li>
                <%= index + 1 %>. 
                <%- place.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') %>
                - Thời gian: <%= place.time ? new Date(place.time).toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }) : 'Chưa đặt thời gian' %>
                <form action="/itineraries/<%= itinerary.id %>/remove-place" method="POST" style="display:inline;">
                  <input type="hidden" name="placeId" value="<%= place.id %>">
                  <button type="submit">Xóa</button>
                </form>
              </li>
            <% }); %>
          <% } else { %>
            <li>Chưa có địa điểm nào trong lịch trình.</li>
          <% } %>
        </ol>

        <div class="itinerary-actions" style="display:flex; gap:12px; align-items:center; margin:12px 0;">
          <button id="toggle-edit-form-btn" class="btn btn-ghost">Sửa lịch trình</button>
          <button id="delete-itinerary-btn" class="btn btn-danger" data-itinerary-id="<%= itinerary.id %>">Xóa lịch trình</button>
        </div>

        <div id="editForm" style="display: none; margin-top: 12px;">
          <form id="edit-itinerary-form" action="/itineraries/<%= itinerary.id %>/edit" method="POST">
            <label>Sửa tên lịch trình</label>
            <input type="text" name="name" value="<%- itinerary.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&apos;') %>" required>

            <h4>Danh sách địa điểm hiện tại</h4>
            <ul id="editPlaceList">
              <% if (itinerary.places && itinerary.places.length > 0) { %>
                <% itinerary.places.forEach(place => { %>
                  <li class="edit-place-item" data-place-id="<%= place.id %>" data-place-time="<%= place.time || '' %>">
                    <%- place.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&apos;') %> 
                    (<%- (place.type || 'Unknown').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&apos;') %>)
                    <input type="datetime-local" value="<%= place.time ? new Date(place.time).toISOString().slice(0, 16) : '' %>">
                    <button type="button" class="remove-place-btn" data-place-id="<%= place.id %>">Xóa</button>
                  </li>
                <% }); %>
              <% } else { %>
                <li>Chưa có địa điểm nào.</li>
              <% } %>
            </ul>

            <h4>Thêm địa điểm mới</h4>
            <select id="addPlaceSelect">
              <option value="">Chọn địa điểm</option>
            </select>
            <input type="datetime-local" id="newPlaceTime" placeholder="Thời gian ghé thăm">
            <button type="button" id="add-place-btn">Thêm</button>

            <input type="hidden" name="places" id="editPlacesInput">
            <button type="submit">Lưu thay đổi</button>
          </form>
        </div>
      <% } else { %>
        <p>Bạn cần đăng nhập để xem chi tiết lịch trình.</p>
      <% } %>

      <a href="/itineraries/page">Quay lại danh sách lịch trình</a>
    <% } else { %>
      <p>Không tìm thấy lịch trình.</p>
      <a href="/itineraries/page">Quay lại danh sách lịch trình</a>
    <% } %>
  </div> <!-- /.container -->

  <script src="/js/main.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Gắn sự kiện cho nút "Sửa lịch trình"
      const toggleEditFormBtn = document.getElementById('toggle-edit-form-btn');
      if (toggleEditFormBtn) {
        toggleEditFormBtn.addEventListener('click', () => {
          if (typeof toggleEditForm === 'function') {
            toggleEditForm();
          } else {
            console.error('toggleEditForm is not defined');
            alert('Lỗi: Không thể mở form chỉnh sửa. Vui lòng thử lại.');
          }
        });
      }

      // Gắn sự kiện cho nút "Xóa lịch trình"
      const deleteItineraryBtn = document.getElementById('delete-itinerary-btn');
      if (deleteItineraryBtn) {
        const itineraryId = deleteItineraryBtn.dataset.itineraryId;
        deleteItineraryBtn.addEventListener('click', () => {
          if (typeof deleteItinerary === 'function') {
            deleteItinerary(parseInt(itineraryId));
          } else {
            console.error('deleteItinerary is not defined');
            alert('Lỗi: Không thể xóa lịch trình. Vui lòng thử lại.');
          }
        });
      }

      // Gắn sự kiện submit cho form chỉnh sửa
      const editForm = document.getElementById('edit-itinerary-form');
      if (editForm) {
        editForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const nameInput = editForm.querySelector('input[name="name"]');
          const placesInput = editForm.querySelector('input[name="places"]');
          const name = nameInput.value.trim();
          let places = placesInput.value ? JSON.parse(placesInput.value) : [];
          if (!name) {
            alert('Vui lòng nhập tên lịch trình');
            return;
          }
          if (!Array.isArray(places) || places.length === 0) {
            alert('Vui lòng chọn ít nhất một địa điểm');
            return;
          }
          if (places.some(p => !p.time)) {
            alert('Vui lòng nhập thời gian cho tất cả địa điểm');
            return;
          }
          editForm.submit();
        });
      }

      // GẮN SỰ KIỆN onchange QUA JS (an toàn hơn)
      document.querySelectorAll('.edit-place-item input[type="datetime-local"]').forEach(input => {
        input.addEventListener('change', function() {
          const placeId = parseInt(this.closest('.edit-place-item').dataset.placeId);
          const time = this.value;
          if (typeof window.updatePlaceTimeInEdit === 'function') {
            window.updatePlaceTimeInEdit(placeId, time);
          } else {
            console.error('window.updatePlaceTimeInEdit chưa sẵn sàng');
          }
        });
      });

      // Delegate clicks for remove-place buttons inside the edit list
      const editPlaceList = document.getElementById('editPlaceList');
      if (editPlaceList) {
        editPlaceList.addEventListener('click', (e) => {
          const btn = e.target.closest('.remove-place-btn');
          if (!btn) return;
          const pid = parseInt(btn.dataset.placeId, 10);
          if (Number.isInteger(pid) && typeof window.removePlaceFromEdit === 'function') {
            window.removePlaceFromEdit(pid);
          }
        });
      }

      // Attach Add place button handler
      const addPlaceBtn = document.getElementById('add-place-btn');
      if (addPlaceBtn) {
        addPlaceBtn.addEventListener('click', () => {
          if (typeof addPlaceToEdit === 'function') addPlaceToEdit();
        });
      }
    });
  </script>
</body>
</html>