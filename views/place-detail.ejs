<!DOCTYPE html>

<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title><%= place.name %> - Th√¥ng tin ƒë·ªãa ƒëi·ªÉm</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
    />
    <style>
      body {
        font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px auto;
        max-width: 1000px;
        background: #f9f9f9;
        color: #333;
      }
      a {
        color: #007bff;
        text-decoration: none;
      }
      a:hover {
        color: #0056b3;
      }
      .btn-back-text {
        display: inline-block;
        margin-bottom: 15px;
        font-weight: bold;
        cursor: pointer;
        text-decoration: underline;
      }
      .place-header {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        align-items: flex-start;
      }
      .place-header img {
        max-width: 300px;
        border-radius: 10px;
        object-fit: cover;
        flex-shrink: 0;
      }
      .place-info {
        flex: 1;
      }
      .place-info h1 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 2em;
        color: #007bff;
      }
      .place-info p {
        margin: 6px 0;
        line-height: 1.5;
      }
      .btn-route {
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
        transition: 0.2s;
      }
      .btn-route:hover {
        background: #0056b3;
      }
      #map {
        height: 500px;
        width: 100%;
        position: relative;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }
      .nearby-section {
        margin-top: 30px;
      }
      .nearby-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .nearby-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.2s;
      }
      .nearby-card:hover {
        transform: translateY(-3px);
      }
      .nearby-card img {
        width: 100%;
        height: 130px;
        object-fit: cover;
      }
      .nearby-card-body {
        padding: 10px;
      }
      .nearby-card-body a {
        font-weight: bold;
        font-size: 1em;
      }
      .nearby-card-body small {
        display: block;
        margin-top: 4px;
        color: #666;
      }

      .leaflet-routing-container {
        max-height: 480px;
        overflow-y: auto;
        background: white;
        z-index: 1000;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
        padding: 5px;
      }
      .leaflet-routing-container h2,
      .leaflet-routing-container h3 {
        font-size: 16px;
        margin: 12px 0 8px 0;
        color: #007bff;
      }
      .leaflet-routing-alt {
        padding: 10px;
        border-bottom: 1px solid #e0e0e0;
      }
      .leaflet-routing-alt h3 {
        margin: 0 0 8px 0;
      }
      .leaflet-routing-instruction {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        margin-bottom: 4px;
        border-radius: 6px;
        background: #f5f8ff;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }
      .leaflet-routing-instruction:hover {
        background: #e8f1ff;
      }
      .step-icon {
        width: 20px;
        text-align: center;
        font-size: 18px;
        color: #007bff;
      }
      .close-routing-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #ff4d4d;
        color: white;
        width: 24px;
        height: 24px;
        font-weight: bold;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        cursor: pointer;
        z-index: 1100;
      }
      .close-routing-btn:hover {
        background: #cc0000;
      }

      .leaflet-routing-geocoders input[type="text"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <a href="/" class="btn-back-text">‚Üê Quay l·∫°i trang ch·ªß</a>
    <div class="place-header">
      <% if(place.image_url){ %>
      <img src="<%= place.image_url %>" alt="<%= place.name %>" />
      <% } %>
      <div class="place-info">
        <h1><%= place.name %></h1>
        <p><strong>ƒê·ªãa ch·ªâ:</strong> <%= place.address %></p>
        <p><strong>Lo·∫°i:</strong> <%= place.type %></p>
        <% if(place.rating){ %>
        <p><strong>Rating:</strong> <%= place.rating %> / 5</p>
        <% } %>
        <p><strong>M√¥ t·∫£:</strong> <%= place.description %></p>
        <button class="btn-route" id="btn-route">G·ª£i √Ω ƒë∆∞·ªùng ƒëi</button>
      </div>
    </div>
    <div id="map"></div>
    <div class="nearby-section">
      <h3>ƒê·ªãa ƒëi·ªÉm g·∫ßn ƒë√¢y</h3>
      <div class="nearby-list" id="nearby-list"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script>
      // L·∫•y d·ªØ li·ªáu t·ª´ server (EJS)
      const place = <%- JSON.stringify(place) %>;

      // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
      const map = L.map('map').setView([place.geometry.coordinates[1], place.geometry.coordinates[0]], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Marker cho ƒë·ªãa ƒëi·ªÉm
      L.marker([place.geometry.coordinates[1], place.geometry.coordinates[0]]).addTo(map)
        .bindPopup(`<b>${place.name}</b><br>${place.address}`)
        .openPopup();

      // Nearby places
      fetch(`/places/${place.id}/nearby`).then(r => r.json()).then(data => {
        const nearbyList = document.getElementById("nearby-list");
        nearbyList.innerHTML = "";
        data.nearby.forEach(p => {
          const card = document.createElement("div");
          card.className = "nearby-card";
          card.innerHTML = `<img src="${p.image_url || 'https://placehold.co/130x130/007bff/ffffff?text=Travel'}" alt="${p.name}"><div class="nearby-card-body"><a href="/places/${p.id}">${p.name}</a><small>${Math.round(p.distance)} m - ${p.type || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ'}</small></div>`;
          nearbyList.appendChild(card);
          // Th√™m marker cho c√°c ƒë·ªãa ƒëi·ªÉm l√¢n c·∫≠n
          L.marker([p.geometry.coordinates[1], p.geometry.coordinates[0]]).addTo(map).bindPopup(`<b>${p.name}</b><br>${p.address || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ'}`);
        });
      });

      // H√†m d·ªãch instruction sang ti·∫øng Vi·ªát
      function translateInstruction(text) {
        // Step 1: Chu·∫©n h√≥a kho·∫£ng c√°ch
        text = text.replace(/([a-zA-Z])(\d+)(\s*m|\s*km)/g, (match, p1, p2, p3) => {
            return p1 + ' ' + p2 + p3.trim();
        });
        text = text.replace(/(\d+)(\s*m|\s*km)([a-zA-Z])/g, (match, p1, p2, p3) => {
            return p1 + p2.trim() + ' ' + p3;
        });

        // Step 2: X·ª≠ l√Ω c√°c c·ª•m t·ª´ d√†i v√† ph·ª©c t·∫°p (∆∞u ti√™n)
        text = text
            .replace(/Enter the traffic circle and take the (\d+)(?:st|nd|rd|th) exit onto/gi, (match, p1) => {
              return `V√†o v√≤ng xuy·∫øn v√† ƒëi theo l·ªëi ra th·ª© ${p1} v√†o`;
            })
            .replace(/Make a sharp right/gi, "R·∫Ω g·∫•p ph·∫£i")
            .replace(/Make a sharp left/gi, "R·∫Ω g·∫•p tr√°i")
            .replace(/Make a slight right to stay on/gi, "R·∫Ω nh·∫π ph·∫£i ƒë·ªÉ ti·∫øp t·ª•c tr√™n")
            .replace(/Make a slight left to stay on/gi, "R·∫Ω nh·∫π tr√°i ƒë·ªÉ ti·∫øp t·ª•c tr√™n")
            .replace(/Continue straight to stay on/gi, "ƒêi th·∫≥ng ti·∫øp tr√™n")
            .replace(/Keep right at the fork/gi, "Gi·ªØ b√™n ph·∫£i t·∫°i ng√£ ba")
            .replace(/Keep left at the fork/gi, "Gi·ªØ b√™n tr√°i t·∫°i ng√£ ba")
            .replace(/Merge left onto/gi, "Nh·∫≠p l√†n tr√°i v√†o")
            .replace(/Merge right onto/gi, "Nh·∫≠p l√†n ph·∫£i v√†o")
            .replace(/Take the ramp on the left/gi, "ƒêi v√†o ƒë∆∞·ªùng nh√°nh b√™n tr√°i")
            .replace(/Take the ramp on the right/gi, "ƒêi v√†o ƒë∆∞·ªùng nh√°nh b√™n ph·∫£i")
            .replace(/Take the ramp/gi, "ƒêi v√†o ƒë∆∞·ªùng nh√°nh")
            .replace(/Go straight/gi, "ƒêi th·∫≥ng")
            .replace(/You have arrived at your destination/gi, "B·∫°n ƒë√£ ƒë·∫øn ƒë√≠ch")
            .replace(/At the end of the road/gi, "·ªû cu·ªëi ƒë∆∞·ªùng")
            .replace(/Exit the traffic circle onto/gi, "Ra kh·ªèi v√≤ng xuy·∫øn v√†o")
            .replace(/Exit the traffic circle/gi, "Ra kh·ªèi v√≤ng xuy·∫øn")
            .replace(/Enter the traffic circle/gi, "V√†o v√≤ng xuy·∫øn");

        // Step 3: D·ªãch c√°c h∆∞·ªõng ch√≠nh (Head Direction)
        text = text.replace(/Head (north|south|east|west|northeast|northwest|southeast|southwest)/gi, (match, p1) => {
            const direction = p1.toLowerCase();
            const map = {
                'north': 'B·∫Øc', 'south': 'Nam', 'east': 'ƒê√¥ng', 'west': 'T√¢y',
                'northeast': 'ƒê√¥ng B·∫Øc', 'northwest': 'T√¢y B·∫Øc',
                'southeast': 'ƒê√¥ng Nam', 'southwest': 'T√¢y Nam'
            };
            return `ƒêi v·ªÅ ph√≠a ${map[direction]}`;
        });

        // Step 4: D·ªãch c√°c h√†nh ƒë·ªông/c·ª•m t·ª´ c√≤n l·∫°i
        text = text
          .replace(/Turn right onto/gi, "R·∫Ω ph·∫£i v√†o")
          .replace(/Turn left onto/gi, "R·∫Ω tr√°i v√†o")
          .replace(/Turn right/gi, "R·∫Ω ph·∫£i")
          .replace(/Turn left/gi, "R·∫Ω tr√°i")
          .replace(/Continue straight/gi, "ƒêi th·∫≥ng")
          .replace(/Continue onto/gi, "ƒêi ti·∫øp v√†o")
          .replace(/Continue on/gi, "Ti·∫øp t·ª•c tr√™n")
          .replace(/Make a slight right/gi, "R·∫Ω nh·∫π ph·∫£i")
          .replace(/Make a slight left/gi, "R·∫Ω nh·∫π tr√°i")
          .replace(/Keep right/gi, "Gi·ªØ b√™n ph·∫£i")
          .replace(/Keep left/gi, "Gi·ªØ b√™n tr√°i")
          .replace(/Arrive at/gi, "ƒê·∫øn")
          .replace(/Destination/gi, "ƒêi·ªÉm ƒë·∫øn")
          .replace(/Finish/gi, "K·∫øt th√∫c")
          .replace(/Exit/gi, "L·ªëi ra")
          .replace(/on the right/gi, "b√™n ph·∫£i")
          .replace(/on the left/gi, "b√™n tr√°i")
          .replace(/onto/gi, "v√†o");

        // Step 5: D·ªãch c√°c ƒë∆°n v·ªã
        text = text
            .replace(/km/gi, " km")
            .replace(/m/gi, " m");

        return text;
      }

      // Icon cho t·ª´ng b∆∞·ªõc (d√πng k√Ω t·ª± Unicode/Emoji)
      function getStepIcon(text) {
        text = text.toLowerCase();
        if (text.includes("r·∫Ω tr√°i") || text.includes("nh·∫π tr√°i") || text.includes("gi·ªØ b√™n tr√°i")) return "‚Ü∞";
        if (text.includes("r·∫Ω ph·∫£i") || text.includes("nh·∫π ph·∫£i") || text.includes("gi·ªØ b√™n ph·∫£i")) return "‚Ü±";
        if (text.includes("ƒëi th·∫≥ng") || text.includes("ti·∫øp t·ª•c")) return "‚Üë";
        if (text.includes("v√≤ng xuy·∫øn")) return "‚ü≥";
        if (text.includes("ƒë·∫øn ƒë√≠ch") || text.includes("ƒëi·ªÉm ƒë·∫øn") || text.includes("k·∫øt th√∫c")) return "üèÅ";
        return "‚Ä¢"; // M·∫∑c ƒë·ªãnh
      }

      // H√†m d·ªãch c√°c text kh√°c trong panel (ti√™u ƒë·ªÅ, n√∫t, nh√£n th·ªùi gian/kho·∫£ng c√°ch)
      function translatePanel(container) {
        if (!container) return; // B·∫£o v·ªá

        // 1. D·ªãch ti√™u ƒë·ªÅ ch√≠nh "Instructions" v√† c√°c nh√£n tƒ©nh
        container.querySelectorAll('h2').forEach(h2 => {
            if (h2.textContent && h2.textContent.includes("Instructions")) {
                h2.textContent = "H∆∞·ªõng D·∫´n ƒê∆∞·ªùng ƒêi";
            }
        });

        // 2. D·ªãch nh√£n k√©o th·∫£ v√† c√°c ch√∫ th√≠ch kh√°c
        container.querySelectorAll('p').forEach(p => {
            const text = p.textContent;
            if (text) {
                if (text.includes("Drag markers to change route")) {
                    p.textContent = "K√©o c√°c ƒëi·ªÉm ƒë·ªÉ thay ƒë·ªïi l·ªô tr√¨nh";
                } else if (text.includes("Finding route...")) {
                    p.textContent = "ƒêang t√¨m l·ªô tr√¨nh...";
                } else if (text.includes("Route not found.")) {
                    p.textContent = "Kh√¥ng t√¨m th·∫•y l·ªô tr√¨nh.";
                }
            }
        });

        // 3. D·ªãch c√°c n√∫t v√† link ("Show/Hide alternatives")
        container.querySelectorAll('a').forEach(el => {
          const text = el.textContent ? el.textContent.trim() : null; // Ki·ªÉm tra null
          if (text) {
            if (text.includes('Show')) {
                el.textContent = el.textContent.replace(/Show/gi, "Hi·ªán");
            }
            if (text.includes('Hide')) {
                el.textContent = el.textContent.replace(/Hide/gi, "·∫®n");
            }
            // D·ªãch t·ª´ "Alternative" (n·∫øu c√≥)
            el.textContent = el.textContent.replace(/alternative/gi, "tuy·∫øn ƒë∆∞·ªùng kh√°c");
          }
        });
      }

      // H√†m d·ªãch v√† t·∫°o l·∫°i n·ªôi dung c·ªßa t·ª´ng b∆∞·ªõc h∆∞·ªõng d·∫´n
      function translateAndRenderInstructions(container, route) {
        if (!container || !route) return; // B·∫£o v·ªá

        // B∆Ø·ªöC 1: D·ªãch nh√£n tƒ©nh (ti√™u ƒë·ªÅ, nh√£n k√©o th·∫£, v.v.)
        translatePanel(container);

        // B∆Ø·ªöC 2: D·ªãch summary (t·ªïng kho·∫£ng c√°ch v√† th·ªùi gian)
        const summaryDiv = container.querySelector('.leaflet-routing-alt h3');
        if (summaryDiv && route && route.summary) {
            const distance = (route.summary.totalDistance / 1000).toFixed(1);
            const timeInMinutes = Math.round(route.summary.totalTime / 60);

            let timeStr = "";
            const hours = Math.floor(timeInMinutes / 60);
            const minutes = timeInMinutes % 60;

            if (hours > 0) timeStr += `${hours} gi·ªù `;
            if (minutes > 0 || hours === 0) timeStr += `${minutes} ph√∫t`;

            summaryDiv.textContent = `Tuy·∫øn ƒë∆∞·ªùng: ${distance} km, ${timeStr.trim()}`;
        }

        // B∆Ø·ªöC 3: D·ªãch t·ª´ng instruction chi ti·∫øt v√† th√™m icon
        const instructions = container.querySelectorAll(".leaflet-routing-instruction");
        instructions.forEach(step => {
            const raw = step.textContent;
            if (raw) { // Ch·ªâ d·ªãch n·∫øu c√≥ n·ªôi dung
                const translated = translateInstruction(raw);
                const icon = getStepIcon(translated);
                // Thay th·∫ø n·ªôi dung b·∫±ng icon v√† chu·ªói ƒë√£ d·ªãch
                step.innerHTML = `<span class="step-icon">${icon}</span><span>${translated}</span>`;
            }
        });
      }

      let routingControl;

      document.getElementById("btn-route").addEventListener("click", () => {
        if (!navigator.geolocation) {
          console.error("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");
          return;
        }

        // T·∫Øt n√∫t ƒë·ªÉ tr√°nh click k√©p
        const routeBtn = document.getElementById("btn-route");
        routeBtn.disabled = true;
        routeBtn.textContent = "ƒêang t√¨m v·ªã tr√≠...";


        navigator.geolocation.getCurrentPosition(pos => {
          const userLatLng = [pos.coords.latitude, pos.coords.longitude];

          // Re-enable button
          routeBtn.disabled = false;
          routeBtn.textContent = "G·ª£i √Ω ƒë∆∞·ªùng ƒëi";

          // D·ªçn d·∫πp routing control c≈©
          if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
          }

          // T·∫°o routing control m·ªõi
          routingControl = L.Routing.control({
            waypoints: [
              { latLng: L.latLng(userLatLng[0], userLatLng[1]), name: 'V·ªã tr√≠ hi·ªán t·∫°i' },
              { latLng: L.latLng(place.geometry.coordinates[1], place.geometry.coordinates[0]), name: place.name }
            ],
            routeWhileDragging: false,
            showAlternatives: true,
            createMarker: (i, wp) => L.marker(wp.latLng, { draggable: false }),
            collapsible: true
          }).addTo(map);

          const container = routingControl.getContainer();

          // D·ªãch nh√£n tƒ©nh ban ƒë·∫ßu (v√≠ d·ª•: "Finding route...")
          translatePanel(container);


          // S·ª± ki·ªán khi t√¨m ƒë∆∞·ª£c route
          routingControl.on('routesfound', (e) => {

            // TH√äM N√öT ƒê√ìNG V√ÄO CONTAINER M·ªöI
            if (!container.querySelector('.close-routing-btn')) {
              const closeBtn = document.createElement("div");
              closeBtn.className = 'close-routing-btn';
              closeBtn.innerText = '√ó';
              closeBtn.onclick = () => {
                map.removeControl(routingControl);
                routingControl = null;
              };
              container.appendChild(closeBtn);
            }

            // S·ª≠ d·ª•ng setTimeout (500ms) ƒë·ªÉ ch·ªù DOM ho√†n t·∫•t render tr∆∞·ªõc khi d·ªãch
            setTimeout(() => {
                translateAndRenderInstructions(container, e.routes[0]);
                console.log("ƒê√£ d·ªãch h∆∞·ªõng d·∫´n sau 500ms timeout.");
            }, 500);
          });

          // S·ª± ki·ªán khi kh√¥ng t√¨m th·∫•y route (v√≠ d·ª•: l·ªói m·∫°ng, kh√¥ng c√≥ ƒë∆∞·ªùng)
          routingControl.on('routingerror', (e) => {
              console.error("L·ªñI ƒê·ªäNH TUY·∫æN: ", e.error);
              // D·ªãch th√¥ng b√°o l·ªói n·∫øu c√≥
              translatePanel(container);
          });

        }, err => {
          // X·ª≠ l√Ω l·ªói Geolocation (v√≠ d·ª•: t·ª´ ch·ªëi quy·ªÅn)
          routeBtn.disabled = false;
          routeBtn.textContent = "G·ª£i √Ω ƒë∆∞·ªùng ƒëi";
          console.error("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i. Vui l√≤ng c·∫•p quy·ªÅn ƒë·ªãnh v·ªã cho tr√¨nh duy·ªát: " + err.message);
        });
      });
    </script>
  </body>
</html>
